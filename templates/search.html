{% extends "base.html" %}

{% block title %}Search Results{% endblock %}

{% block content %}
<div class="search-container">
    <div class="search-header">
        <h1>Search Results</h1>
        <p class="results-count">Found {{ articles|length }} articles</p>
    </div>

    <div class="search-layout">
        <!-- Filters Sidebar -->
        <aside class="filters-sidebar">
            <form method="get" action="{{ url_for('search') }}">
                <div class="filters-header">
                    <h2 class="filters-title">Filters</h2>
                    <a href="{{ url_for('search') }}" class="clear-filters">Clear all</a>
                </div>

                <!-- Tags Filter -->
                <div class="filter-section">
                    <label class="filter-label">Tags</label>
                    <div class="tag-chips">
                        {% for tag in all_tags %}
                        <span class="tag-chip {% if tag in selected_tags %}active{% endif %} {{ tag|get_tag_class }}" onclick="toggleTag(this)">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="tags" id="selected-tags-input" value="{{ selected_tags|join(',') }}">
                </div>

                <!-- Authors Filter -->
                <div class="filter-section">
                    <label class="filter-label">Authors</label>
                    <div class="author-options">
                        {% for author in all_authors %}
                        <label class="checkbox-wrapper">
                            <input type="checkbox" name="authors" value="{{ author }}" {% if author in selected_authors %}checked{% endif %}>
                            <span class="checkbox-label">{{ author }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Date Range Filter -->
                <div class="filter-section">
                    <label class="filter-label">Date Range</label>
                    <div class="date-group">
                        <div class="date-input-wrapper">
                            <label class="date-label-small">From</label>
                            <input type="date" name="start_date" id="startDate" value="{{ start_date }}">
                        </div>
                        <div class="date-input-wrapper">
                            <label class="date-label-small">To</label>
                            <input type="date" name="end_date" id="endDate" value="{{ end_date }}">
                        </div>
                    </div>
                </div>

                <button class="apply-filters-btn" type="submit">Apply Filters</button>
            </form>
        </aside>

        <!-- Results Area -->
        <main class="results-area search-results">
            <!-- Active Filters Display -->
            <div class="active-filters" id="activeFilters">
                {% for tag in selected_tags %}
                <div class="active-filter-chip" data-type="tag">
                    <span>{{ tag }}</span>
                    <button class="remove-filter" onclick="removeFilter(this)">√ó</button>
                </div>
                {% endfor %}
                {% for author in selected_authors %}
                <div class="active-filter-chip" data-type="author">
                    <span>{{ author }}</span>
                    <button class="remove-filter" onclick="removeFilter(this)">√ó</button>
                </div>
                {% endfor %}
                {% if start_date and end_date %}
                <div class="active-filter-chip" data-type="date">
                    <span>{{ start_date }} - {{ end_date }}</span>
                    <button class="remove-filter" onclick="removeFilter(this)">√ó</button>
                </div>
                {% endif %}
            </div>

            {% for article in articles %}
            <article class="article-card">
                <div class="article-content">
                    <div class="article-header">
                        <div class="article-tags">
                        {% for tag in article.tags %}
                            <span class="tag {{ tag|get_tag_class }}">{{ tag }}</span>
                        {% endfor %}
                        </div>
                        <h2 class="article-title">
                            <a href="{{ url_for('article', article_id=article.id) }}">{{ article.title }}</a>
                        </h2>
                        <p class="article-excerpt">
                            {{ article.content | truncate(150) }}
                        </p>
                    </div>
                    <footer class="article-footer">
                        <div class="article-meta">
                            <span class="meta-item">
                                <span class="meta-icon">‚úçÔ∏è</span>
                                <span class="author-name">{{ article.author }}</span>
                            </span>
                            <span class="meta-item">
                                <span class="meta-icon">üìÖ</span>
                                <span>{{ article.created_at.strftime('%b %d, %Y') }}</span>
                            </span>
                        </div>
                        <div class="read-time">
                            <span>üìñ</span>
                            <span>5 min read</span>
                        </div>
                    </footer>
                </div>
            </article>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <h3 class="empty-state-title">No articles found</h3>
                <p class="empty-state-text">Try adjusting your filters or search terms</p>
            </div>
            {% endfor %}
        </main>
    </div>
</div>

<script>
    function toggleTag(element) {
        element.classList.toggle('active');
        updateSelectedTagsInput();
    }

    function updateSelectedTagsInput() {
        const activeTags = Array.from(document.querySelectorAll('.tag-chip.active'))
            .map(chip => chip.textContent);
        document.getElementById('selected-tags-input').value = activeTags.join(',');
    }

    function removeFilter(button) {
        const chip = button.closest('.active-filter-chip');
        const type = chip.getAttribute('data-type');
        const text = chip.querySelector('span').textContent;

        chip.remove();

        if (type === 'tag') {
            const tagChip = Array.from(document.querySelectorAll('.tag-chip'))
                .find(el => el.textContent === text);
            if (tagChip) {
                tagChip.classList.remove('active');
                updateSelectedTagsInput();
            }
        } else if (type === 'author') {
            const checkbox = Array.from(document.querySelectorAll('.checkbox-label'))
                .find(el => el.textContent === text)
                ?.previousElementSibling;
            if (checkbox) checkbox.checked = false;
        } else if (type === 'date') {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
        }
        
        // Automatically resubmit the form
        document.querySelector('.filters-sidebar form').submit();
    }
</script>
{% endblock %}

